version: '3.7'

networks:
  cbrw:
#    driver: bridge
#    name: cbrw
#    ipam:
#      driver: default
#      config:
#        - subnet: 192.168.220.0/24

services:
  cbrw_web:
#    hostname: cbrw_web
    container_name: cbrw_web
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./hosts:/etc/nginx/conf.d
      - ./public:/var/www
      - ./var/log/nginx:/var/log/nginx
    links:
      - cbrw_php
    extra_hosts:
      - "cbrw:127.0.0.1"
    networks:
      - cbrw
#      - cbr-watcher_default

  cbrw_php:
#    hostname: cbrw_php
    container_name: cbrw_php
    restart: always
    build:
      context: ./
      dockerfile: php.Dockerfile
    volumes:
      - ./:/var/www
      - ./var/tmp:/tmp
      - ./var:/var/www/var
    environment:
      HTTP_PROXY:
      HTTPS_PROXY:
      http_proxy:
      https_proxy:
      XDEBUG_MODE: debug,profile
#      XDEBUG_CONFIG: client_host=192.168.220.1 client_port=9003 mode=debug,profile start_with_request=yes discover_client_host=false
      XDEBUG_CONFIG: client_port=9003 mode=debug,profile start_with_request=yes discover_client_host=false
      PHP_IDE_CONFIG: serverName=Docker
      REDIS_HOST: redis
      REDIS_PORT: 6400
    links:
      - redis
    networks:
      - cbrw
#      - cbr-watcher_default

  redis:
    container_name: redis
    build:
      context: ./redis
      dockerfile: Dockerfile
    restart: always
    ports:
      - 6400:6379
    networks:
      - cbrw
#      - cbr-watcher_default
